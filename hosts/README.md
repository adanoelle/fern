# ðŸ–¥ï¸ Host Configurations

> **Purpose:** Machine-specific NixOS configurations  
> **Type:** System Configuration  
> **Status:** Stable

## Overview

This directory contains host-specific configurations for NixOS machines. Each
subdirectory represents a complete system configuration, combining system
modules and home manager modules to create a fully configured machine.

## Quick Start

```bash
# Rebuild the current host
sudo nixos-rebuild switch --flake .#fern

# Test changes without switching
sudo nixos-rebuild test --flake .#fern

# Build a specific host
sudo nixos-rebuild build --flake .#hostname

# Update and rebuild
nix flake update
sudo nixos-rebuild switch --flake .#fern
```

## What's Inside

| Host    | Purpose                         | Hardware                   | Status |
| ------- | ------------------------------- | -------------------------- | ------ |
| `fern/` | Primary development workstation | Desktop PC with Nvidia GPU | Active |

## Host Structure

Each host directory follows this pattern:

```
hostname/
â”œâ”€â”€ configuration.nix    # Main system configuration
â”œâ”€â”€ hardware-configuration.nix  # Hardware-specific settings
â””â”€â”€ README.md           # Host-specific documentation
```

## Configuration Components

### System Configuration (`configuration.nix`)

Combines all system aspects:

1. **Hardware** - Imports hardware-configuration.nix
2. **Modules** - System and home modules
3. **Networking** - Hostname, interfaces
4. **Users** - User accounts and groups
5. **Services** - System services
6. **Boot** - Bootloader and kernel

### Hardware Configuration (`hardware-configuration.nix`)

Auto-generated hardware settings:

- File systems and mount points
- Boot device configuration
- Kernel modules for hardware
- CPU and GPU configuration
- Network interfaces

**Note:** Usually generated by `nixos-generate-config`

## Fern Host Configuration

### Overview

Primary development workstation with:

- Nvidia GPU (RTX series)
- Zen kernel
- Hyprland desktop
- Full development environment

### Key Features

```nix
# System modules enabled
- boot (Zen kernel)
- audio (PipeWire)
- graphics (Nvidia)
- fonts
- core (Nix configuration)
- secrets (SOPS)
- greetd (Display manager)

# Development tools
- docker
- rust-dev
- typescript
- python-dev
- c-toolchain

# Desktop applications
- vscode
- cursor
- claude
- teams
- lmstudio
```

### Users

```nix
users.users.ada = {
  isNormalUser = true;
  description = "Ada";
  extraGroups = [ "wheel" "networkmanager" "docker" "video" "audio" ];
  shell = pkgs.nushell;
};
```

### Home Manager

Extensive user configuration:

- CLI tools
- Git suite
- Desktop environment
- Development tools
- Shell configuration

## Creating a New Host

### 1. Generate Hardware Configuration

```bash
# Boot from NixOS installer
sudo nixos-generate-config --root /mnt --dir /tmp/config
```

### 2. Create Host Directory

```bash
mkdir hosts/newhostname
cp /tmp/config/* hosts/newhostname/
```

### 3. Configure System

Edit `configuration.nix`:

```nix
{ config, pkgs, self, ... }:

{
  imports = [
    ./hardware-configuration.nix
    self.nixosModules.core
    self.nixosModules.boot
    # Add more modules
  ];

  networking.hostName = "newhostname";

  # System configuration
  time.timeZone = "America/New_York";

  # User configuration
  users.users.username = {
    isNormalUser = true;
    extraGroups = [ "wheel" ];
  };

  # Home Manager
  home-manager.users.username = {
    imports = [
      self.homeModules.cli
      # Add home modules
    ];
  };
}
```

### 4. Register in Flake

Edit `flake.nix`:

```nix
nixosConfigurations = {
  newhostname = nixpkgs.lib.nixosSystem {
    system = "x86_64-linux";
    modules = [
      ./hosts/newhostname/configuration.nix
    ];
  };
};
```

### 5. Deploy

```bash
sudo nixos-rebuild switch --flake .#newhostname
```

## Multi-Host Management

### Shared Configuration

Create shared modules for common settings:

```nix
# hosts/common.nix
{ ... }:
{
  # Shared across all hosts
  time.timeZone = "America/New_York";
  i18n.defaultLocale = "en_US.UTF-8";

  # Common packages
  environment.systemPackages = with pkgs; [
    vim
    git
    htop
  ];
}
```

### Host-Specific Overrides

```nix
# In host configuration
{
  imports = [
    ../common.nix
    # Host-specific modules
  ];

  # Override shared settings
  services.xserver.enable = lib.mkForce false;
}
```

## Remote Deployment

### Using nixos-rebuild

```bash
# Deploy to remote host
nixos-rebuild switch \
  --flake .#hostname \
  --target-host user@hostname \
  --use-remote-sudo
```

### Using deploy-rs

```nix
# In flake.nix
deploy.nodes.hostname = {
  hostname = "192.168.1.100";
  profiles.system = {
    user = "root";
    path = deploy-rs.lib.x86_64-linux.activate.nixos
      self.nixosConfigurations.hostname;
  };
};
```

## Hardware Profiles

### Desktop Workstation

```nix
# High-performance setup
boot.kernelPackages = pkgs.linuxPackages_zen;
hardware.nvidia.enable = true;
services.xserver.videoDrivers = [ "nvidia" ];
```

### Laptop

```nix
# Power management
services.tlp.enable = true;
services.auto-cpufreq.enable = true;
hardware.bluetooth.enable = true;
```

### Server

```nix
# Headless configuration
services.openssh.enable = true;
services.fail2ban.enable = true;
networking.firewall.enable = true;
```

### Virtual Machine

```nix
# VM optimizations
services.qemuGuest.enable = true;
services.spice-vdagentd.enable = true;
boot.initrd.availableKernelModules = [ "virtio_pci" ];
```

## Troubleshooting

### Configuration Errors

```bash
# Check configuration without applying
sudo nixos-rebuild dry-build --flake .#hostname

# Show evaluation errors
sudo nixos-rebuild build --flake .#hostname --show-trace

# Test in VM
nixos-rebuild build-vm --flake .#hostname
./result/bin/run-hostname-vm
```

### Rollback

```bash
# List generations
sudo nix-env --list-generations -p /nix/var/nix/profiles/system

# Rollback to previous
sudo nixos-rebuild --rollback switch

# Switch to specific generation
sudo nix-env -p /nix/var/nix/profiles/system --switch-generation 42
```

### Hardware Issues

```bash
# Regenerate hardware config
sudo nixos-generate-config --show-hardware-config

# Check detected hardware
lspci  # PCI devices
lsusb  # USB devices
lsblk  # Block devices
```

## Best Practices

1. **Keep hardware config separate** - Don't edit hardware-configuration.nix
2. **Use modules** - Share common configuration
3. **Version control** - Commit working configurations
4. **Test first** - Use `nixos-rebuild test` before switching
5. **Document changes** - Note why configuration changed
6. **Backup** - Keep working configurations safe
7. **Pin versions** - Use flake.lock for reproducibility

## See Also

- **[System Modules](../nix/modules/)** - Available system modules
- **[Home Modules](../nix/home/)** - Available home modules
- **[Architecture](../docs/ARCHITECTURE.md)** - System design
- **[NixOS Manual](https://nixos.org/manual/nixos/stable/)** - Official
  documentation

---

_Each host is unique - configure it to match its purpose and hardware._
